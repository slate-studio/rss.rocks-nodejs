(function(){var e,r,t,n,s;global._after=function(e,r){if("function"!=typeof r)throw new TypeError(FUNC_ERROR_TEXT);return e="number"==typeof e&&isFinite(e=+e)?e:0,function(){return--e<1?r.apply(this,arguments):void 0}},Array.prototype.unique=function(){var e,r,t,n,s,i;for(r={},e=n=0,s=this.length;s>=0?s>n:n>s;e=s>=0?++n:--n)r[this[e]]=this[e];i=[];for(e in r)t=r[e],i.push(t);return i},Array.prototype.appendArray=function(e){return Array.prototype.push.apply(this,e)},Array.prototype.clone=function(e){return this.slice(0)},n=require("./parser"),e=require("./cacher"),s=require("./sender"),r=require("firebase"),module.exports=t=function(){function t(){this.firebaseAppName="rss-rocks",this.firebaseRef=new r("https://"+this.firebaseAppName+".firebaseio.com"),this.usersRef=this.firebaseRef.child("users")}return t.prototype.start=function(){return this.usersRef.on("value",function(e){return function(r){return e.usersRef.off(),e.users=r.val(),e.pullFeedsOutOfSubscriptions(),e.feeds.length>0?e.sendEmailsWithNewPosts():(console.log("no subscriptions"),process.exit())}}(this))},t.prototype.pullFeedsOutOfSubscriptions=function(){var e,r,t,n,s;e=[],s=this.users,n=function(r,t){var n,s,i;return i=function(){var e,r;e=t.subscriptions,r=[];for(n in e)s=e[n],r.push(s.url);return r}(),e.appendArray(i)};for(t in s)r=s[t],n(t,r);return this.feeds=e.unique()},t.prototype.sendEmailsWithNewPosts=function(){return new n(this.feeds,function(r){return function(t){return console.log("feeds fetched"),new e(r.firebaseRef,t,function(e){return new s(r.users,e,function(){return process.exit()})})}}(this))},t}()}).call(this);