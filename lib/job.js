(function(){var e,r,t,s,n;global._after=function(e,r){if("function"!=typeof r)throw new TypeError(FUNC_ERROR_TEXT);return e="number"==typeof e&&isFinite(e=+e)?e:0,function(){return--e<1?r.apply(this,arguments):void 0}},Array.prototype.unique=function(){var e,r,t,s,n,i;for(r={},e=s=0,n=this.length;n>=0?n>s:s>n;e=n>=0?++s:--s)r[this[e]]=this[e];i=[];for(e in r)t=r[e],i.push(t);return i},s=require("./parser"),e=require("./cacher"),n=require("./sender"),r=require("firebase"),module.exports=t=function(){function t(){this.firebaseAppName="rss-rocks",this.firebaseRef=new r("https://"+this.firebaseAppName+".firebaseio.com"),this.usersRef=this.firebaseRef.child("users")}return t.prototype.start=function(){return this.usersRef.on("value",function(e){return function(r){return e.usersRef.off(),e.users=r.val(),e.pullFeedsOutOfSubscriptions(),e.feeds.length>0?e.sendEmailsWithNewPosts():(console.log("no subscriptions"),process.exit())}}(this))},t.prototype.pullFeedsOutOfSubscriptions=function(){var e,r,t,s,n;e=[],n=this.users,s=function(r,t){var s,n,i;return i=function(){var e,r;e=t.subscriptions,r=[];for(s in e)n=e[s],r.push(n.url);return r}(),Array.prototype.push.apply(e,i)};for(t in n)r=n[t],s(t,r);return this.feeds=e.unique()},t.prototype.sendEmailsWithNewPosts=function(){return new s(this.feeds,function(r){return function(t){return console.log("feeds fetched"),new e(r.firebaseRef,t,function(e){return new n(r.usersRef,e,function(){return console.log("done"),process.exit()})})}}(this))},t}()}).call(this);