// Generated by CoffeeScript 1.8.0
(function() {
  var Cacher, Firebase, Job, Parser, Sender;

  global._after = function(n, func) {
    if (!(typeof func === 'function' || false)) {
      throw new TypeError(FUNC_ERROR_TEXT);
    }
    n = typeof n === 'number' && isFinite(n = +n) ? n : 0;
    return function() {
      if (--n < 1) {
        return func.apply(this, arguments);
      }
    };
  };

  Array.prototype.unique = function() {
    var key, output, value, _i, _ref, _results;
    output = {};
    for (key = _i = 0, _ref = this.length; 0 <= _ref ? _i < _ref : _i > _ref; key = 0 <= _ref ? ++_i : --_i) {
      output[this[key]] = this[key];
    }
    _results = [];
    for (key in output) {
      value = output[key];
      _results.push(value);
    }
    return _results;
  };

  Array.prototype.appendArray = function(array) {
    return Array.prototype.push.apply(this, array);
  };

  Array.prototype.clone = function(array) {
    return this.slice(0);
  };

  Parser = require('./parser');

  Cacher = require('./cacher');

  Sender = require('./sender');

  Firebase = require('firebase');

  module.exports = Job = (function() {
    function Job() {
      this.firebaseAppName = 'rss-rocks';
      this.firebaseRef = new Firebase("https://" + this.firebaseAppName + ".firebaseio.com");
      this.usersRef = this.firebaseRef.child('users');
    }

    Job.prototype.start = function() {
      return this.usersRef.on('value', (function(_this) {
        return function(snapshot) {
          _this.usersRef.off();
          _this.users = snapshot.val();
          _this.pullFeedsOutOfSubscriptions();
          if (_this.feeds.length > 0) {
            return _this.sendEmailsWithNewPosts();
          } else {
            console.log('no subscriptions');
            return process.exit();
          }
        };
      })(this));
    };

    Job.prototype.pullFeedsOutOfSubscriptions = function() {
      var feeds, profile, uid, _fn, _ref;
      feeds = [];
      _ref = this.users;
      _fn = function(uid, profile) {
        var id, s, urls;
        urls = (function() {
          var _ref1, _results;
          _ref1 = profile.subscriptions;
          _results = [];
          for (id in _ref1) {
            s = _ref1[id];
            _results.push(s.url);
          }
          return _results;
        })();
        return feeds.appendArray(urls);
      };
      for (uid in _ref) {
        profile = _ref[uid];
        _fn(uid, profile);
      }
      return this.feeds = feeds.unique();
    };

    Job.prototype.sendEmailsWithNewPosts = function() {
      return new Parser(this.feeds, (function(_this) {
        return function(feedsAndPosts) {
          console.log('feeds fetched');
          return new Cacher(_this.firebaseRef, feedsAndPosts, function(feedsAndNewPosts) {
            return new Sender(_this.users, feedsAndNewPosts, function() {
              return process.exit();
            });
          });
        };
      })(this));
    };

    return Job;

  })();

}).call(this);
